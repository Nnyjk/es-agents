FROM golang:1.23 AS builder
WORKDIR /src
COPY . .
RUN go mod download
RUN TARGET_GLIBC_VERSION=2.34 ./scripts/verify-linux-compat.sh /out/host-agent

FROM alpine:3.19
RUN adduser -D -h /app appuser
COPY --from=builder /out/host-agent /app/host-agent
USER appuser
EXPOSE 9090
ENTRYPOINT ["/app/host-agent"]
