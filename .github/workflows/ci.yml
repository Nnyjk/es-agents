name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Frontend Build & Test
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
    
    - name: Type check
      run: npm run type-check
    
    - name: Lint
      run: npm run lint
    
    - name: Build
      run: npm run build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist
        retention-days: 7

  # Server Build & Test
  server:
    name: Server CI
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Build with Maven
      run: mvn -B package --file server/pom.xml
    
    - name: Run tests
      run: mvn test --file server/pom.xml
    
    - name: Upload server artifacts
      uses: actions/upload-artifact@v4
      with:
        name: server-jar
        path: server/target/*.jar
        retention-days: 7

  # Agent Build
  agent:
    name: Agent CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./agent
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache-dependency-path: agent/go.sum
    
    - name: Build
      run: go build -v ./...
    
    - name: Test
      run: go test -v ./...

  # Documentation Check
  docs:
    name: Docs Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check documentation structure
      run: |
        echo "Checking documentation structure..."
        find docs -name "*.md" | head -20
        echo "✓ Documentation check passed"

  # Labeler (Auto-label PRs)
  labeler:
    name: Auto Labeler
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Auto label PR
      uses: actions/labeler@v5
      with:
        repo-token: "${{ secrets.GITHUB_TOKEN }}"
        configuration-path: .github/labeler.yml

  # Notify on Success/Failure
  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [frontend, server, agent, docs]
    if: always()
    
    steps:
    - name: Check build status
      run: |
        if [ "${{ needs.frontend.result }}" == "failure" ] || \
           [ "${{ needs.server.result }}" == "failure" ] || \
           [ "${{ needs.agent.result }}" == "failure" ]; then
          echo "❌ Build failed"
          exit 1
        else
          echo "✅ All builds passed"
        fi
