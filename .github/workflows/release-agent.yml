name: HostAgent Release

on:
  push:
    tags:
      - 'agent-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., agent-v1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    name: Build and Release HostAgent
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./agent
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache-dependency-path: agent/go.sum
    
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ inputs.version }}"
        else
          VERSION="${{ github.ref_name }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
    
    - name: Create output directory
      run: mkdir -p bin
    
    - name: Build for Linux (amd64)
      run: |
        echo "Building host-agent for Linux (amd64)..."
        GOOS=linux GOARCH=amd64 go build -o bin/host-agent-linux-amd64 ./cmd/host-agent
        echo "Building host-agent for Linux (arm64)..."
        GOOS=linux GOARCH=arm64 go build -o bin/host-agent-linux-arm64 ./cmd/host-agent
    
    - name: Build for Windows (amd64)
      run: |
        echo "Building host-agent for Windows (amd64)..."
        GOOS=windows GOARCH=amd64 go build -o bin/host-agent-windows-amd64.exe ./cmd/host-agent
    
    - name: Build for macOS
      run: |
        echo "Building host-agent for macOS (amd64)..."
        GOOS=darwin GOARCH=amd64 go build -o bin/host-agent-darwin-amd64 ./cmd/host-agent
        echo "Building host-agent for macOS (arm64)..."
        GOOS=darwin GOARCH=arm64 go build -o bin/host-agent-darwin-arm64 ./cmd/host-agent
    
    - name: Create installation packages
      run: |
        # Create Linux package
        mkdir -p package-linux
        cp bin/host-agent-linux-amd64 package-linux/host-agent
        cp rootCA.pem package-linux/ 2>/dev/null || true
        cat > package-linux/install.sh << 'EOF'
        #!/bin/bash
        echo "Installing Host Agent..."
        chmod +x host-agent
        sudo cp host-agent /usr/local/bin/
        echo "Host Agent installed successfully!"
        echo "To start: sudo host-agent"
        EOF
        chmod +x package-linux/install.sh
        tar -czvf bin/host-agent-linux.tar.gz -C package-linux .
        
        # Create Windows package
        mkdir -p package-windows
        cp bin/host-agent-windows-amd64.exe package-windows/host-agent.exe
        cp rootCA.pem package-windows/ 2>/dev/null || true
        cat > package-windows/install.bat << 'EOF'
        @echo off
        echo Installing Host Agent...
        copy host-agent.exe C:\Windows\System32\
        echo Host Agent installed successfully!
        echo To start: host-agent.exe
        EOF
        tar -czvf bin/host-agent-windows.tar.gz -C package-windows .
        
        # Create macOS package
        mkdir -p package-macos
        cp bin/host-agent-darwin-amd64 package-macos/host-agent-intel
        cp bin/host-agent-darwin-arm64 package-macos/host-agent-arm
        cp rootCA.pem package-macos/ 2>/dev/null || true
        cat > package-macos/install.sh << 'EOF'
        #!/bin/bash
        echo "Installing Host Agent..."
        chmod +x host-agent-intel host-agent-arm
        sudo cp host-agent-intel /usr/local/bin/host-agent
        echo "Host Agent installed successfully!"
        echo "To start: sudo host-agent"
        EOF
        chmod +x package-macos/install.sh
        tar -czvf bin/host-agent-macos.tar.gz -C package-macos .
        
        echo "Packages created:"
        ls -lh bin/*.tar.gz
    
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: HostAgent ${{ steps.get_version.outputs.version }}
        draft: false
        prerelease: false
        body: |
          ## HostAgent Release
          
          ### Downloads
          - **Linux (amd64)**: `host-agent-linux.tar.gz`
          - **Linux (arm64)**: `host-agent-linux-arm64`
          - **Windows (amd64)**: `host-agent-windows.tar.gz`
          - **macOS (Intel)**: `host-agent-macos.tar.gz` (includes arm64)
          
          ### Installation
          
          #### Linux/macOS
          ```bash
          tar -zxvf host-agent-*.tar.gz
          chmod +x install.sh
          sudo ./install.sh
          ```
          
          #### Windows
          Extract the archive and run `install.bat` as Administrator.
          
          ### Configuration
          Host Agent will connect to Server via WebSocket.
          Configure `gatewayUrl` in the Server when registering the host.
      files: |
        bin/host-agent-linux.tar.gz
        bin/host-agent-linux-arm64
        bin/host-agent-windows.tar.gz
        bin/host-agent-macos.tar.gz
      token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload standalone binaries
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        files: |
          bin/host-agent-linux-amd64
          bin/host-agent-linux-arm64
          bin/host-agent-windows-amd64.exe
          bin/host-agent-darwin-amd64
          bin/host-agent-darwin-arm64
      token: ${{ secrets.GITHUB_TOKEN }}
