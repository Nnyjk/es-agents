name: HostAgent Release

on:
  push:
    tags:
      - 'agent-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., agent-v1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    name: Build and Release HostAgent
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./agent
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache-dependency-path: agent/go.sum
    
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ inputs.version }}"
        else
          VERSION="${{ github.ref_name }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
    
    - name: Create output directory
      run: mkdir -p bin
    
    - name: Build for Linux (amd64)
      run: |
        echo "Building host-agent for Linux (amd64)..."
        GOOS=linux GOARCH=amd64 go build -o bin/host-agent-linux-amd64 ./cmd/host-agent
        echo "Building host-agent for Linux (arm64)..."
        GOOS=linux GOARCH=arm64 go build -o bin/host-agent-linux-arm64 ./cmd/host-agent
    
    - name: Build for Windows (amd64)
      run: |
        echo "Building host-agent for Windows (amd64)..."
        GOOS=windows GOARCH=amd64 go build -o bin/host-agent-windows-amd64.exe ./cmd/host-agent
    
    - name: Build for macOS
      run: |
        echo "Building host-agent for macOS (amd64)..."
        GOOS=darwin GOARCH=amd64 go build -o bin/host-agent-darwin-amd64 ./cmd/host-agent
        echo "Building host-agent for macOS (arm64)..."
        GOOS=darwin GOARCH=arm64 go build -o bin/host-agent-darwin-arm64 ./cmd/host-agent
    
    - name: Create installation packages
      run: |
        # Create Linux package
        mkdir -p package-linux
        cp bin/host-agent-linux-amd64 package-linux/host-agent
        cp rootCA.pem package-linux/ 2>/dev/null || true
        
        # Config template
        cat > package-linux/config.yaml << 'CONFIGEOF'
        # HostAgent Configuration
        listen_port: 9090
        host_id: ""  # Will be set during installation
        secret_key: ""  # Will be set during installation
        heartbeat_interval: 30s
        CONFIGEOF
        
        # install.sh
        cat > package-linux/install.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "=== HostAgent Installation ==="
        
        # Detect installation directory
        INSTALL_DIR="${INSTALL_DIR:-/opt/host-agent}"
        BIN_DIR="/usr/local/bin"
        
        echo "Installing to: $INSTALL_DIR"
        
        # Create installation directory
        sudo mkdir -p "$INSTALL_DIR"
        
        # Copy files
        sudo cp host-agent "$INSTALL_DIR/"
        sudo cp config.yaml "$INSTALL_DIR/"
        sudo cp stop.sh "$INSTALL_DIR/"
        sudo cp uninstall.sh "$INSTALL_DIR/"
        sudo cp update.sh "$INSTALL_DIR/"
        [ -f rootCA.pem ] && sudo cp rootCA.pem "$INSTALL_DIR/"
        
        # Make executable
        sudo chmod +x "$INSTALL_DIR/host-agent"
        sudo chmod +x "$INSTALL_DIR/stop.sh"
        sudo chmod +x "$INSTALL_DIR/uninstall.sh"
        sudo chmod +x "$INSTALL_DIR/update.sh"
        
        # Create symlink
        sudo ln -sf "$INSTALL_DIR/host-agent" "$BIN_DIR/host-agent"
        
        echo ""
        echo "Installation complete!"
        echo ""
        echo "Configuration:"
        echo "  - Edit config file: $INSTALL_DIR/config.yaml"
        echo "  - Set host_id and secret_key in config.yaml"
        echo ""
        echo "Management commands:"
        echo "  - Start:  sudo $INSTALL_DIR/host-agent"
        echo "  - Stop:   sudo $INSTALL_DIR/stop.sh"
        echo "  - Uninstall: sudo $INSTALL_DIR/uninstall.sh"
        echo "  - Update: sudo $INSTALL_DIR/update.sh <version>"
        echo ""
        echo "Logs: $INSTALL_DIR/host-agent.log"
        EOF
        chmod +x package-linux/install.sh
        
        # stop.sh
        cat > package-linux/stop.sh << 'EOF'
        #!/bin/bash
        set -e
        
        INSTALL_DIR="${INSTALL_DIR:-/opt/host-agent}"
        PID_FILE="$INSTALL_DIR/pid"
        
        if [ -f "$PID_FILE" ]; then
            PID=$(cat "$PID_FILE")
            if kill -0 "$PID" 2>/dev/null; then
                echo "Stopping HostAgent (PID: $PID)..."
                kill "$PID"
                rm -f "$PID_FILE"
                echo "HostAgent stopped."
            else
                echo "HostAgent is not running (stale PID file)."
                rm -f "$PID_FILE"
            fi
        else
            # Try to find by process name
            PID=$(pgrep -f "host-agent" || true)
            if [ -n "$PID" ]; then
                echo "Stopping HostAgent (PID: $PID)..."
                kill "$PID"
                echo "HostAgent stopped."
            else
                echo "HostAgent is not running."
            fi
        fi
        EOF
        chmod +x package-linux/stop.sh
        
        # uninstall.sh
        cat > package-linux/uninstall.sh << 'EOF'
        #!/bin/bash
        set -e
        
        INSTALL_DIR="${INSTALL_DIR:-/opt/host-agent}"
        BIN_DIR="/usr/local/bin"
        
        echo "=== HostAgent Uninstallation ==="
        
        # Stop the agent first
        if [ -f "$INSTALL_DIR/stop.sh" ]; then
            bash "$INSTALL_DIR/stop.sh" || true
        fi
        
        # Remove symlink
        sudo rm -f "$BIN_DIR/host-agent"
        
        # Remove installation directory
        echo "Removing $INSTALL_DIR..."
        sudo rm -rf "$INSTALL_DIR"
        
        echo ""
        echo "Uninstallation complete!"
        echo "Note: Log files and custom configs in $INSTALL_DIR have been removed."
        EOF
        chmod +x package-linux/uninstall.sh
        
        # update.sh
        cat > package-linux/update.sh << 'EOF'
        #!/bin/bash
        set -e
        
        INSTALL_DIR="${INSTALL_DIR:-/opt/host-agent}"
        VERSION="${1:-latest}"
        
        echo "=== HostAgent Update ==="
        echo "Target version: $VERSION"
        
        # Stop current agent
        if [ -f "$INSTALL_DIR/stop.sh" ]; then
            bash "$INSTALL_DIR/stop.sh"
        fi
        
        # Download new version (placeholder - implement based on your release strategy)
        echo "Downloading new version..."
        # TODO: Implement actual download logic based on your release hosting
        # Example: curl -L "https://github.com/your-repo/releases/download/$VERSION/host-agent-linux.tar.gz" -o /tmp/host-agent.tar.gz
        
        echo "Update complete! Please restart the agent."
        echo "Start with: sudo $INSTALL_DIR/host-agent"
        EOF
        chmod +x package-linux/update.sh
        
        # Create tar.gz package
        tar -czvf bin/host-agent-linux.tar.gz -C package-linux .
        
        # Create Windows package
        mkdir -p package-windows
        cp bin/host-agent-windows-amd64.exe package-windows/host-agent.exe
        cp rootCA.pem package-windows/ 2>/dev/null || true
        
        # config.yaml for Windows
        cat > package-windows/config.yaml << 'CONFIGEOF'
        # HostAgent Configuration
        listen_port: 9090
        host_id: ""  # Will be set during installation
        secret_key: ""  # Will be set during installation
        heartbeat_interval: 30s
        CONFIGEOF
        
        # install.bat
        cat > package-windows/install.bat << 'EOF'
        @echo off
        echo === HostAgent Installation ===
        
        set INSTALL_DIR=%PROGRAMFILES%\host-agent
        
        echo Installing to: %INSTALL_DIR%
        
        mkdir "%INSTALL_DIR%" 2>nul
        copy /Y host-agent.exe "%INSTALL_DIR%"
        copy /Y config.yaml "%INSTALL_DIR%"
        copy /Y stop.bat "%INSTALL_DIR%"
        copy /Y uninstall.bat "%INSTALL_DIR%"
        copy /Y update.bat "%INSTALL_DIR%"
        if exist rootCA.pem copy /Y rootCA.pem "%INSTALL_DIR%"
        
        setx PATH "%PATH%;%INSTALL_DIR%"
        
        echo.
        echo Installation complete!
        echo Configuration: %INSTALL_DIR%\config.yaml
        echo Start: host-agent.exe
        echo Stop: stop.bat
        EOF
        
        # stop.bat
        cat > package-windows/stop.bat << 'EOF'
        @echo off
        echo Stopping HostAgent...
        taskkill /F /IM host-agent.exe 2>nul
        if %ERRORLEVEL% EQU 0 (
            echo HostAgent stopped.
        ) else (
            echo HostAgent is not running.
        )
        EOF
        
        # uninstall.bat
        cat > package-windows/uninstall.bat << 'EOF'
        @echo off
        echo === HostAgent Uninstallation ===
        
        call stop.bat
        
        set INSTALL_DIR=%PROGRAMFILES%\host-agent
        
        echo Removing %INSTALL_DIR%...
        rmdir /S /Q "%INSTALL_DIR%"
        
        echo.
        echo Uninstallation complete!
        EOF
        
        # update.bat
        cat > package-windows/update.bat << 'EOF'
        @echo off
        echo === HostAgent Update ===
        echo Target version: %1
        
        call stop.bat
        
        echo Downloading new version...
        echo TODO: Implement actual download logic
        
        echo.
        echo Update complete! Restart with: host-agent.exe
        EOF
        
        tar -czvf bin/host-agent-windows.tar.gz -C package-windows .
        
        # Create macOS package
        mkdir -p package-macos
        cp bin/host-agent-darwin-amd64 package-macos/host-agent-intel
        cp bin/host-agent-darwin-arm64 package-macos/host-agent-arm
        cp rootCA.pem package-macos/ 2>/dev/null || true
        
        # config.yaml for macOS
        cat > package-macos/config.yaml << 'CONFIGEOF'
        # HostAgent Configuration
        listen_port: 9090
        host_id: ""  # Will be set during installation
        secret_key: ""  # Will be set during installation
        heartbeat_interval: 30s
        CONFIGEOF
        
        # install.sh for macOS
        cat > package-macos/install.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "=== HostAgent Installation ==="
        
        INSTALL_DIR="${INSTALL_DIR:-/opt/host-agent}"
        BIN_DIR="/usr/local/bin"
        
        echo "Installing to: $INSTALL_DIR"
        
        sudo mkdir -p "$INSTALL_DIR"
        sudo cp host-agent-intel "$INSTALL_DIR/"
        sudo cp host-agent-arm "$INSTALL_DIR/"
        sudo cp config.yaml "$INSTALL_DIR/"
        sudo cp stop.sh "$INSTALL_DIR/"
        sudo cp uninstall.sh "$INSTALL_DIR/"
        sudo cp update.sh "$INSTALL_DIR/"
        [ -f rootCA.pem ] && sudo cp rootCA.pem "$INSTALL_DIR/"
        
        # Detect architecture and create appropriate symlink
        ARCH=$(uname -m)
        if [ "$ARCH" = "arm64" ]; then
            sudo ln -sf "$INSTALL_DIR/host-agent-arm" "$BIN_DIR/host-agent"
        else
            sudo ln -sf "$INSTALL_DIR/host-agent-intel" "$BIN_DIR/host-agent"
        fi
        
        sudo chmod +x "$INSTALL_DIR/host-agent-intel"
        sudo chmod +x "$INSTALL_DIR/host-agent-arm"
        sudo chmod +x "$INSTALL_DIR/stop.sh"
        sudo chmod +x "$INSTALL_DIR/uninstall.sh"
        sudo chmod +x "$INSTALL_DIR/update.sh"
        
        echo ""
        echo "Installation complete!"
        echo "Configuration: $INSTALL_DIR/config.yaml"
        echo "Start: sudo host-agent"
        echo "Stop: sudo $INSTALL_DIR/stop.sh"
        echo "Logs: $INSTALL_DIR/host-agent.log"
        EOF
        chmod +x package-macos/install.sh
        
        # stop.sh for macOS
        cat > package-macos/stop.sh << 'EOF'
        #!/bin/bash
        set -e
        
        INSTALL_DIR="${INSTALL_DIR:-/opt/host-agent}"
        PID_FILE="$INSTALL_DIR/pid"
        
        if [ -f "$PID_FILE" ]; then
            PID=$(cat "$PID_FILE")
            if kill -0 "$PID" 2>/dev/null; then
                echo "Stopping HostAgent (PID: $PID)..."
                kill "$PID"
                rm -f "$PID_FILE"
                echo "HostAgent stopped."
            else
                echo "HostAgent is not running (stale PID file)."
                rm -f "$PID_FILE"
            fi
        else
            PID=$(pgrep -f "host-agent" || true)
            if [ -n "$PID" ]; then
                echo "Stopping HostAgent (PID: $PID)..."
                kill "$PID"
                echo "HostAgent stopped."
            else
                echo "HostAgent is not running."
            fi
        fi
        EOF
        chmod +x package-macos/stop.sh
        
        # uninstall.sh for macOS
        cat > package-macos/uninstall.sh << 'EOF'
        #!/bin/bash
        set -e
        
        INSTALL_DIR="${INSTALL_DIR:-/opt/host-agent}"
        BIN_DIR="/usr/local/bin"
        
        echo "=== HostAgent Uninstallation ==="
        
        if [ -f "$INSTALL_DIR/stop.sh" ]; then
            bash "$INSTALL_DIR/stop.sh" || true
        fi
        
        sudo rm -f "$BIN_DIR/host-agent"
        echo "Removing $INSTALL_DIR..."
        sudo rm -rf "$INSTALL_DIR"
        
        echo ""
        echo "Uninstallation complete!"
        EOF
        chmod +x package-macos/uninstall.sh
        
        # update.sh for macOS
        cat > package-macos/update.sh << 'EOF'
        #!/bin/bash
        set -e
        
        INSTALL_DIR="${INSTALL_DIR:-/opt/host-agent}"
        VERSION="${1:-latest}"
        
        echo "=== HostAgent Update ==="
        echo "Target version: $VERSION"
        
        if [ -f "$INSTALL_DIR/stop.sh" ]; then
            bash "$INSTALL_DIR/stop.sh"
        fi
        
        echo "Downloading new version..."
        # TODO: Implement actual download logic
        
        echo "Update complete! Please restart the agent."
        echo "Start with: sudo host-agent"
        EOF
        chmod +x package-macos/update.sh
        
        tar -czvf bin/host-agent-macos.tar.gz -C package-macos .
        
        echo "Packages created:"
        ls -lh bin/*.tar.gz
    
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: HostAgent ${{ steps.get_version.outputs.version }}
        draft: false
        prerelease: false
        body: |
          ## HostAgent Release
          
          ### Downloads
          - **Linux (amd64)**: `host-agent-linux.tar.gz`
          - **Linux (arm64)**: `host-agent-linux-arm64` (standalone binary)
          - **Windows (amd64)**: `host-agent-windows.tar.gz`
          - **macOS (Intel/ARM)**: `host-agent-macos.tar.gz`
          
          ### Installation
          
          #### Linux/macOS
          ```bash
          tar -zxvf host-agent-*.tar.gz
          chmod +x install.sh
          sudo ./install.sh
          ```
          
          #### Windows
          Extract the archive and run `install.bat` as Administrator.
          
          ### Configuration
          
          Edit `config.yaml` after installation:
          ```yaml
          listen_port: 9090
          host_id: "your-host-id"
          secret_key: "your-secret-key"
          heartbeat_interval: 30s
          ```
          
          ### Management
          
          - **Start**: `sudo host-agent` (Linux/macOS) or `host-agent.exe` (Windows)
          - **Stop**: `sudo /opt/host-agent/stop.sh` or `stop.bat`
          - **Uninstall**: `sudo /opt/host-agent/uninstall.sh` or `uninstall.bat`
          - **Update**: `sudo /opt/host-agent/update.sh <version>`
          
          ### Logs
          
          Logs are written to `host-agent.log` in the installation directory.
        files: |
          agent/bin/host-agent-linux.tar.gz
          agent/bin/host-agent-linux-arm64
          agent/bin/host-agent-windows.tar.gz
          agent/bin/host-agent-macos.tar.gz
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload standalone binaries
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        files: |
          agent/bin/host-agent-linux-amd64
          agent/bin/host-agent-linux-arm64
          agent/bin/host-agent-windows-amd64.exe
          agent/bin/host-agent-darwin-amd64
          agent/bin/host-agent-darwin-arm64
        token: ${{ secrets.GITHUB_TOKEN }}
