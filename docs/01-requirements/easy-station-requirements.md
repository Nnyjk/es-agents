# Easy-Station 需求设计与功能分析

> 本文基于 `docs/user_action_flowchat.md` 的用户交互流程，完成需求设计与功能分析，用于指导整个项目的构建与验收。严格遵循以下约束：
> 1) 不涉及技术架构与技术选型；2) Proxy 为第三方中间件，描述交互但不在本系统实现范围；3) Server、Agent、前端分开构建；4) 交互以“用户目标”为主导，而非传统导航栏主导。

## 背景与总体目标
- 提供一套围绕“环境、主机、Agent”的目标驱动平台，帮助运维与开发在统一界面下完成 Agent 的资源维护、打包、部署、状态/日志查看与命令执行。
- 将复杂流程（选择环境/主机、配置资源来源、准备判定、打包部署、通信与状态更新）抽象为清晰的目标与步骤，提升可用性与可观测性。
- 明确范围与边界：通信依赖 Proxy（第三方），本系统不实现代理层，仅负责与代理层的交互契约与错误提示。

## 核心概念与术语
- Environment（环境）：用于组织主机与部署目标的逻辑域，如 `dev`、`staging`、`prod`。
- Host（主机）：部署 Agent 的机器或容器运行节点，隶属于某个环境。
- Agent（代理程序）：在主机上执行命令、上报状态与日志、承载部署包的运行体。
- AgentResource（资源来源）：Agent 的代码/包来源；支持本地上传、Git 仓库、HTTP 下载、Docker 仓库、阿里云仓库等。
- Package（打包）：将 Agent 与其依赖产出为可部署单元的过程与结果。
- Deployment（部署）：把打包结果投放到目标环境与主机并完成启动/启用的过程与结果。
- Command（命令）：通过 Agent 在主机上执行的操作与参数集合。
- Status（状态）：Agent 的生命周期状态与健康度（准备、打包、部署、运行）。
- Log（日志）：Agent 运行时输出、部署过程记录与命令执行结果。
- Proxy（主机网关）：第三方通信中间件；负责 Server 与 Agent 的消息转发与通道管理（不在本系统实现）。
 - Host Agent (Runner)：运行在主机上的守护进程，内置通信能力（与 Server 建立 WebSocket 长连接）与定时调度能力，负责在当前环境与主机范围调用 Agent 并聚合结果与日志。
- Agent (Plugin/Task)：作为 Host Agent 的能力插件或由 Host Agent 调用的脚本/辅助程序，面向具体职能（如文件传递、命令执行、数据库备份等）；由 Host Agent 进行调用并回传执行结果与日志。
- AgentTemplate（Agent模板）：未绑定环境与主机的通用定义，包含资源来源与配置参数，可生成多个实例。
- AgentInstance（Agent实体/实例）：由模板生成并绑定到特定环境与主机的可部署与可运行实体。
 - Binding（绑定）：AgentInstance 与 Environment、Host 的绑定关系与约束，确保执行域与资源访问边界明确。

## 用户角色与权限
- 管理员（Admin）：具备全部权限；配置系统规则、审计、管理环境/主机/Agent、下发命令、查看状态与日志。
- 运维（Ops）：管理环境与主机；手动部署 Host Agent；查看状态与日志；执行命令；受权限策略约束。
- 开发者（Dev）：新增与维护 Agent 及资源来源；触发打包与部署（需授权）；查看状态与日志。
- 只读（Viewer）：查看环境/主机/Agent 列表与状态/日志，不可变更。
- 权限要点（需求级）：
  - 创建/编辑/删除：环境、主机、Agent、资源来源（按角色授权）。
  - 部署与命令：仅 Admin/Ops/授权 Dev；命令参数需合法校验与审计记录。
  - 查看：所有角色可见范围可配置（例如按环境隔离）。

## 用户目标与任务地图（Goal-Driven）
- 目标：在指定环境与主机“部署一个 Agent”
  - 步骤：选择环境 → 选择主机 → 检查 Agent 准备 → 打包 → 部署 → 部署完成判定 → 结果反馈。
  - 成功条件：部署完成且状态更新为“已部署”；失败给出可恢复动作（返回配置/重试/切换主机）。
- 目标：查看某 Agent 的实时“状态与日志”
  - 步骤：选择环境/主机/Agent → 拉取状态与日志 → 自动刷新与错误提示。
  - 成功条件：状态/日志展示完整且刷新正常；错误场景明确提示与重试入口。
- 目标：在主机上通过 Agent“执行命令”
  - 步骤：选择目标主机与 Agent → 填写命令与参数 → 发送 → 显示执行结果与可重试。
  - 成功条件：命令执行完成并返回结果；失败可重试并记录审计。
- 目标：新增并“配置 Agent 资源来源”
  - 步骤：新增 Agent → 选择资源来源（本地/Git/HTTP/Docker/阿里云）→ 完成配置校验 → 准备完成判定。
  - 成功条件：资源来源可验证、版本/包完整；准备状态达到“可用”。
- 目标：新建“环境与主机”并完成初始配置
  - 步骤：新建环境 → 新建主机（配置网关地址） → 生成 Host Agent 安装包（tar.gz） → 手动部署 Host Agent → 完成主机检查与元数据校验。
  - 成功条件：环境/主机创建成功且 Host Agent 连接正常；可用于后续部署与命令执行。
  - 安装包说明：Host Agent 部署包为 tar.gz 格式，包含 config.yaml 与 install.sh，支持 Linux/Windows/Linux-Docker 环境解压与安装。
  - 配置说明：网关地址（Gateway URL）用于 Agent 连接 Server，支持自定义（默认为 http://localhost:8080）。

## 关键业务流程（基于 flowchart 改写）
- 登录：用户登录系统 → 进入 Dashboard（目标面板）。
- 运维路径：选择环境 → 选择主机 → 主机动作：
  - 获取 Agent 列表（AgentList）
  - 选择 Agent（SelectAgent）并查看状态（AgentStatus）与日志（AgentLog）
  - 执行命令（CommandAgent）→ 通过 Proxy 发送（外部中间件）
- 开发路径：新增 Agent（NewAgent）→ 配置资源来源（AgentResource：本地/Git/HTTP/Docker/阿里云）→ 准备完成判定（IfAgentCompleted）。
- 打包与部署：准备完成 → 打包 Agent（PackageAgent）→ 线上部署（DeployAgent）→ 部署完成判定（IsDeployedCompleted）→ 成功则“已部署 Agent”（DeployedAgent）。
- 状态更新：DeployedAgent ↔ Proxy ↔ Server → Server 侧更新 Agent 状态（AgentStatus）。
- Proxy 说明：为外部中间件；仅承担通信转发，本系统不实现该层。
 - 消息调用与聚合：Server → Proxy → Host Agent（当前环境/主机）→ Host Agent 调用目标 Agent（如文件传递/命令执行/数据库备份）→ Agent执行并返回结果 → Host Agent 聚合并经 Proxy 回传至 Server。

## 模块分拆与职责（不含技术架构）
- Server（服务端）
  - 用户认证与会话管理；权限与审计。
  - 环境/主机/Agent/资源来源的创建、编辑、删除与查询。
  - Agent 模板/实例/绑定管理：模板定义、实例生成与变更、绑定至环境与主机的校验与记录。
  - 触发打包与部署的入口；记录部署进展与结果。
  - 命令下发入口；与 Proxy 的发送/接收契约；状态与日志入库/聚合；面向 Host Agent 的消息下发协议（需求级）。
  - 统一的错误与事件记录（含可重试策略描述）。
- Agent（代理程序）
  - Host Agent (Runner)：与 Agent (Plugin) 共同为一个单程序体；注册与管理 Agent 能力，接收 Server 经 Proxy 的消息并进行定时调度与调用；聚合 Agent 结果与日志并回传；维护当前环境/主机范围的执行域。
  - Agent (Plugin/Task)：由 Host Agent 调用的能力插件/脚本（如文件传递/命令执行/数据库备份等），按 Host Agent 调用执行并输出结果与日志。
  - 资源来源拉取与校验（本地/Git/HTTP/Docker/阿里云）；自检与“准备完成”判定；打包与部署动作抽象；运行时健康上报；与 Proxy 的通信契约遵循（需求级）。
- 前端（目标导向 UI）
  - 目标面板（Goal Hub）：以“我要做什么”为入口的目标卡片。
  - 任务向导（Wizard）：分步引导，校验前置条件，提供可恢复路径；支持“模板→生成实例→绑定环境与主机”的向导流程与校验提示。
  - 状态/日志可视化：实时/轮询刷新、过滤与搜索、错误提示与重试。
  - 表单与校验：资源来源配置、命令参数、环境/主机元数据校验。
  - 通知与结果页：成功/失败明确反馈，支持回到关键步骤；提供 Agent 维度的执行结果与聚合视图。

## Agent 设定与组成
- 组成：每个部署单元为一个单程序，包含 Host Agent 核心与若干 Agent 能力（插件/脚本/辅助程序）。
- 职责：
    - Host Agent：
      - 部署在目标主机上的守护进程。
      - 监听 Server 连接请求（Server 主动连接 Host Agent）。
      - 管理 Agent Plugin 的生命周期。
      - 采集主机基础指标。
  - Agent (Plugin)：
    - 作为能力插件/脚本提供具体职能（如文件传递、命令执行、数据库备份等）。
    - 按 Host Agent 的调用完成操作并返回结果与日志。
- 管理：支持 Agent 的注册/发现/健康检查；支持在目标环境/主机范围内的启停控制与调度（需求级）。

## 实体与状态模型（需求级）
- Agent 准备状态机：`未配置 → 配置中 → 可用（准备完成） → 打包中 → 已打包 → 部署中 → 已部署 / 失败`
- 部署状态机：`待部署 → 部署中 → 成功 / 失败 → 可回滚`
- 命令执行状态机：`待发送 → 已发送 → 执行中 → 成功 / 失败 → 可重试`
- 关键属性与校验（需求级）：
  - 环境：名称唯一、描述可选、启用/停用标志。
  - 主机：标识唯一、可达性检查、所属环境绑定、标签/元数据。
  - AgentTemplate：资源来源与配置的通用定义；可生成多个 AgentInstance；模板名唯一，参数可校验。
  - AgentInstance：从模板生成并绑定到 Environment 与 Host；实例名或标识唯一；绑定不可为空且需校验主机可达与环境匹配。
  - Agent：名称唯一、版本/渠道、资源来源配置完整性与可验证性（若沿用旧称，需与模板/实例概念保持一致）。
  - 包/部署：版本一致性、完整性校验、目标环境与主机匹配约束。
  - 命令：参数合法性、风险提示、执行超时与重试策略描述。
 - 模板→生成→绑定生命周期（需求级）：
   - 模板创建 → 生成实例 → 绑定至环境与主机 → 准备/打包/部署 → 运行。
   - 约束：一个模板可生成多个实例；一个实例绑定一个环境与一个主机（可根据业务放宽，但需在需求中明确）。

## 目标导向交互原则与页面蓝图
- 以目标驱动代替导航层级：主页展示“部署Agent”“维护资源”“查看状态/日志”“执行命令”“环境/主机管理”等目标卡片。
- 每个目标进入任务向导：
  - 显示前置条件（例如：环境已创建、主机可达、Agent 已准备）。
  - 步骤清晰、可回退；失败提供明确的恢复路径（返回配置、重试或切换目标）。
- 列表/筛选服务于目标：如“选择部署目标主机”的筛选与搜索，而非固定菜单树。
- 实时反馈：状态与日志区域支持自动刷新与手动重试；重要事件提示与可追踪。

## 功能需求清单（按模块）
- 前端
  - 目标面板与任务向导；动态表单与校验；状态/日志视图；通知与结果页；搜索/筛选/分页；（如允许）批量操作；模板→实例→绑定向导与可视化。
- Server
  - 登录与鉴权；环境/主机/Agent/资源来源管理；Agent 模板/实例/绑定管理；打包/部署触发入口与进展记录；命令下发入口；权限与审计；事件记录与查询；状态与日志接入。
- Agent
  - 资源来源支持（本地上传/Git/HTTP/Docker/阿里云）；自检与准备完成判定；打包与部署动作；命令执行；状态与日志输出；Host Agent 与 Agent Plugin 的注册/发现、Host Agent调用 Plugin 与结果聚合（需求级）。

## 异常与边界场景
- 资源不可达/校验失败：提示失败原因，提供返回配置/重试。
- 打包失败/部署失败：展示步骤失败点、错误详情、重试与回滚入口（需求级）。
- 状态/日志不可用：显示离线或不可用提示；支持重新拉取。
- 命令执行失败：错误反馈与可重试；审计记录。
- 权限拒绝：清晰提示与申请入口（需求级）。
- Proxy 不可用：提示通信不可用、建议稍后重试或联系中间件维护（不实现代理层）。
 - 绑定失败：实例与环境/主机的绑定校验失败时，明确错误并提供修正路径；避免脏绑定状态。
 - 子Agent不可用：注册/发现失败或健康检查异常时，提示具体 Agent Plugin 不可用并支持降级或重试。
- Host Agent调用失败：Agent Plugin 脚本缺失/不可执行/超时/返回异常等需记录并反馈；提供重试策略与回退方案（需求级）。
- 结果聚合异常：Plugin 返回不一致或丢失，需在 Host Agent 侧提示并允许重新聚合或人工介入。

## 验收标准与用例示例
- 用例：部署一个 Agent 至生产环境
  - 前置：生产环境与主机存在且可达；Agent 处于“可用”。
  - 步骤：选择环境/主机 → 打包 → 部署 → 部署完成判定。
  - 期望：部署状态为成功；Server 更新状态；前端显示成功结果与回到目标入口。
- 用例：查看某 Agent 的日志与状态
  - 前置：Agent 已部署或可运行。
  - 步骤：选择环境/主机/Agent → 拉取状态与日志 → 自动刷新。
  - 期望：展示完整信息；异常有明确提示与重试入口。
- 用例：通过 Agent 在主机执行命令
  - 前置：主机与 Agent 可用；用户具备权限。
  - 步骤：选择目标 → 填写命令与参数 → 发送 → 显示执行结果。
  - 期望：返回成功或失败结果；支持重试；记录审计。
 - 用例：从模板生成实例并绑定环境与主机
   - 前置：AgentTemplate 已创建且通过校验；目标环境与主机可达。
   - 步骤：选择模板 → 生成 AgentInstance → 绑定 Environment 与 Host → 准备/打包/部署。
   - 期望：绑定成功、部署成功；状态与日志正确展示；失败场景有明确提示与恢复路径。
 - 用例：Host Agent调用 Agent Plugin 执行
   - 前置：Host Agent 与目标 Plugin 已就绪。
   - 步骤：Server 下发消息（经 WebSocket）→ Host Agent 接收并调用目标 Plugin → Plugin 执行并回传结果 → Host Agent 聚合并回传至 Server。
   - 期望：分发与聚合成功；出现 Plugin 异常时有明确错误与重试入口；审计与状态日志完整。
