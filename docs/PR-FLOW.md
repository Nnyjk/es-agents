# PR Flow

## 目标

建立统一的基于 PR 的交付流程，保证代码在进入 `main` 之前完成基础质量门禁，并在合并后自动进入部署、发布和通知阶段。

## 提交流程

1. 从最新的 `main` 拉出功能分支，分支命名建议使用 `feat/*`、`fix/*`、`chore/*`。
2. 在功能分支完成开发，并在本地执行必要检查。
3. 提交代码时使用清晰的 Commit Message，推荐采用 Conventional Commits。
4. 推送分支并创建 PR，按模板补全摘要、验证方式、风险和回滚说明。
5. 等待 PR 自动检查完成，包括编译、测试、lint 和类型检查。
6. 指定对应代码所有者审查，通过后再执行合并。

## 审查清单

- 变更目标是否清晰，是否与需求或缺陷单一致。
- 是否覆盖受影响模块的关键路径和回归风险。
- 是否补充了必要测试，或明确说明无法补充的原因。
- 文档、配置和发布说明是否同步更新。
- 是否存在安全、性能、兼容性或数据变更风险。
- 是否给出了明确的回滚方式。

## 合并条件

- PR 检查全部通过。
- 至少一位代码所有者完成审查并批准。
- 未解决评论已处理，或给出明确处理结论。
- PR 模板中的风险、验证和回滚说明已填写完整。
- 如涉及接口、数据结构或发布行为变更，相关文档已同步更新。

## 回滚流程

1. 确认问题范围：界定受影响模块、时间点和版本。
2. 选择回滚方式：
   - 小范围代码问题：优先通过新的修复 PR 前滚。
   - 已合并且影响生产：对目标提交执行 `revert`，走同样的 PR 审查流程。
   - 涉及部署包：回退到上一个稳定发布产物。
3. 回滚后重新执行编译、测试和必要验证。
4. 在 PR 或事故记录中补充根因、影响面和后续预防措施。

## 本地建议检查

```bash
# Frontend
cd frontend && npm ci --legacy-peer-deps
cd frontend && npm test
cd frontend && npm run build
cd frontend && npx tsc --noEmit

# Server
mvn -B test --file server/pom.xml
mvn -B -DskipTests package --file server/pom.xml

# Agent
cd agent && go test ./...
cd agent && go vet ./...
```
